<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Adventures in Overengineering 1: deploying a Golang web server - Luís Franco</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Adventures in Overengineering 1: deploying a Golang web server"><meta property="og:description" content="There is a wide variety of blog posts on the internet teaching one how to create a simple web server in Golang. But most of them are incredibly boring and minor variations of each other. So I&rsquo;m going to take a different approach: I&rsquo;m going to deploy a simple REST API in Golang. Notice that I said deploy, not create, which means that my first step is a tiny bit different."><meta property="og:type" content="article"><meta property="og:url" content="https://ornlu-is.github.io/overengineering_adventures_1/"><meta property="og:image" content="https://ornlu-is.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-15T20:46:20+00:00"><meta property="article:modified_time" content="2023-03-15T22:57:46+00:00"><meta property="og:site_name" content="Super website"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ornlu-is.github.io/logo.png"><meta name=twitter:title content="Adventures in Overengineering 1: deploying a Golang web server"><meta name=twitter:description content="There is a wide variety of blog posts on the internet teaching one how to create a simple web server in Golang. But most of them are incredibly boring and minor variations of each other. So I&rsquo;m going to take a different approach: I&rsquo;m going to deploy a simple REST API in Golang. Notice that I said deploy, not create, which means that my first step is a tiny bit different."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ornlu-is.github.io/overengineering_adventures_1/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Adventures in Overengineering 1: deploying a Golang web server","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ornlu-is.github.io\/overengineering_adventures_1\/"},"genre":"posts","keywords":"go, kubernetes, docker","wordcount":3678,"url":"https:\/\/ornlu-is.github.io\/overengineering_adventures_1\/","datePublished":"2023-03-15T20:46:20+00:00","dateModified":"2023-03-15T22:57:46+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Luís Franco"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></span></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Adventures in Overengineering 1: deploying a Golang web server</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Luís Franco</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/adventures-in-overengineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Adventures in Overengineering</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-03-15>2023-03-15</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;3678 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;18 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#creating-a-kubernetes-cluster>Creating a Kubernetes Cluster</a></li><li><a href=#enabling-the-kubernetes-dashboard>Enabling the Kubernetes Dashboard</a></li><li><a href=#creating-the-web-server>Creating the web server</a></li><li><a href=#containerizing-our-web-server>Containerizing our web server</a></li><li><a href=#creating-a-kubernetes-namespace>Creating a Kubernetes Namespace</a></li><li><a href=#deploying-our-containerized-web-server-into-our-kubernetes-cluster>Deploying our containerized web server into our Kubernetes cluster</a></li><li><a href=#future-overengineering-steps>Future Overengineering Steps</a></li></ul></nav></div></div><div class=content id=content><p>There is a wide variety of blog posts on the internet teaching one how to create a simple web server in Golang. But most of them are incredibly boring and minor variations of each other. So I&rsquo;m going to take a different approach: I&rsquo;m going to deploy a simple REST API in Golang. Notice that I said <em>deploy</em>, not create, which means that my first step is a tiny bit different.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Link to the code<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><a href=https://github.com/ornlu-is/askeladden/tree/v0.1 target=_blank rel="noopener noreffer">https://github.com/ornlu-is/askeladden/tree/v0.1</a></div></div></div><h2 id=creating-a-kubernetes-cluster>Creating a Kubernetes Cluster</h2><p>Yes, you read that right, the first step is to create our own Kubernetes cluster locally. Why? Because I&rsquo;m too cheap to use any of the cloud providers out there and this has the upside of being a cool learning opportunity.</p><p>After some research, which is just a fancy way of saying &ldquo;looking at the first page of Google results&rdquo;, I found that <code>microk8s</code> is the solution I am looking for getting a local Kubernetes cluster up and running. The official install guide seems straightforward enough so let&rsquo;s give it a go. First step:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>sudo snap install microk8s --classic
</span></span></code></pre></td></tr></table></div></div><p>That was quick enough. The second step in the documentation is to run</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s status --wait-ready
</span></span></code></pre></td></tr></table></div></div><p>Let&rsquo;s do that. And this is where we find our first hurdle. The result of the above command is:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Insufficient permissions to access MicroK8s.
</span></span><span class=line><span class=cl>You can either try again with sudo or add the user luis to the &#39;microk8s&#39; group:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    sudo usermod -a -G microk8s luis
</span></span><span class=line><span class=cl>    sudo chown -R luis ~/.kube
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>After this, reload the user groups either via a reboot or by running &#39;newgrp microk8s&#39;.
</span></span></code></pre></td></tr></table></div></div><p>Running the above as <code>sudo</code> does work, and it outputs the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s is running
</span></span><span class=line><span class=cl>high-availability: no
</span></span><span class=line><span class=cl>  datastore master nodes: 127.0.0.1:19001
</span></span><span class=line><span class=cl>  datastore standby nodes: none
</span></span><span class=line><span class=cl>addons:
</span></span><span class=line><span class=cl>  enabled:
</span></span><span class=line><span class=cl>    ha-cluster           # (core) Configure high availability on the current node
</span></span><span class=line><span class=cl>    helm                 # (core) Helm - the package manager for Kubernetes
</span></span><span class=line><span class=cl>    helm3                # (core) Helm 3 - the package manager for Kubernetes
</span></span><span class=line><span class=cl>  disabled:
</span></span><span class=line><span class=cl>    cert-manager         # (core) Cloud native certificate management
</span></span><span class=line><span class=cl>    community            # (core) The community addons repository
</span></span><span class=line><span class=cl>    dashboard            # (core) The Kubernetes dashboard
</span></span><span class=line><span class=cl>    dns                  # (core) CoreDNS
</span></span><span class=line><span class=cl>    gpu                  # (core) Automatic enablement of Nvidia CUDA
</span></span><span class=line><span class=cl>    host-access          # (core) Allow Pods connecting to Host services smoothly
</span></span><span class=line><span class=cl>    hostpath-storage     # (core) Storage class; allocates storage from host directory
</span></span><span class=line><span class=cl>    ingress              # (core) Ingress controller for external access
</span></span><span class=line><span class=cl>    kube-ovn             # (core) An advanced network fabric for Kubernetes
</span></span><span class=line><span class=cl>    mayastor             # (core) OpenEBS MayaStor
</span></span><span class=line><span class=cl>    metallb              # (core) Loadbalancer for your Kubernetes cluster
</span></span><span class=line><span class=cl>    metrics-server       # (core) K8s Metrics Server for API access to service metrics
</span></span><span class=line><span class=cl>    minio                # (core) MinIO object storage
</span></span><span class=line><span class=cl>    observability        # (core) A lightweight observability stack for logs, traces and metrics
</span></span><span class=line><span class=cl>    prometheus           # (core) Prometheus operator for monitoring and logging
</span></span><span class=line><span class=cl>    rbac                 # (core) Role-Based Access Control for authorisation
</span></span><span class=line><span class=cl>    registry             # (core) Private image registry exposed on localhost:32000
</span></span><span class=line><span class=cl>    storage              # (core) Alias to hostpath-storage add-on, deprecated
</span></span></code></pre></td></tr></table></div></div><p>I wish all obstacles in life were that easy to overcome. But it is cumbersome to write a few extra characters every time I want to interact with <code>microk8s</code>, so I&rsquo;m going to also perform the other step suggested by <code>microk8s</code>, which is to add myself to the <code>microk8s</code> group.</p><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>usermod -a -G microk8s luis<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p>In case you are not aware what <code>usermod</code> is, running <code>man usermod</code> on your Linux machine will elucidate you (<code>man</code> stands for <code>manual</code>, as in, instruction book, not as in manual labour, even though some of these things do sometimes feel like a chore).</p><p>The manual gives us the following short description of <code>usermod</code>: &ldquo;modify a user account&rdquo;. Seems intuitive enough. However, the command <code>microk8s</code> is instructing us to run is <code>sudo usermod -a -G microk8s luis</code>, so we have to look a bit more carefully into the documentation to understand what these flags are.</p><p>The <code>-a</code> flag is shorthand notation for <code>--append</code> which is used to add a user to the group, and <code>-G</code> stands for <code>--groups</code> which is used to specify to which groups we want to add our user. So the command does exactly what one would expect: it adds the user <code>luis</code> (hey, that&rsquo;s me!) to the <code>microk8s</code>.</p></div></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>chown -R luis ~/.kube<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><p><code>man chown</code> tells us that this command is used to change the user and/or group ownership of a given file. We are running it with the <code>-R</code> flag which stands for <code>--recursive</code> and give it the user <code>luis</code> (hey, that&rsquo;s me again!) and the <code>~/.kube</code> directory. Basically, this sets us are the owners of everything inside the given directory.</p><p>I hope that I&rsquo;m not the only one that always mistakenly reads <code>clown</code> instead of <code>chown</code>.</p></div></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>newgrp microk8s<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>While the name might suggest that this command is used to create a new group, surprise, it is not what it does. What it does is change the current group ID during a login session. In other words, it logs me into the group.</div></div></div><p>In the name of saving a few keystrokes and winning back a few seconds of precious lifetime, I have a set an alias for <code>microk8s kubectl</code> via</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>alias mk=&#34;microk8s kubectl&#34;
</span></span></code></pre></td></tr></table></div></div><p>So whenever you read <code>mk</code>, keep it mind that it stands for <code>microk8s kubectl</code>.</p><h2 id=enabling-the-kubernetes-dashboard>Enabling the Kubernetes Dashboard</h2><p>We are running our own local cluster, so we need some easy way to get visibility on what is inside it and what its state is. For that matter, we can use the Kubernetes dashboard add-on.</p><p>Apparently, it is supposed to be super easy to enable a new add-on with <code>microk8s</code>, so let&rsquo;s try getting the Kubernetes dashboard up and running by typing <code>microk8s enable dashboard</code> into our terminal. This outputs the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Infer repository core for addon dashboard
</span></span><span class=line><span class=cl>Enabling Kubernetes Dashboard
</span></span><span class=line><span class=cl>Infer repository core for addon metrics-server
</span></span><span class=line><span class=cl>Enabling Metrics-Server
</span></span><span class=line><span class=cl>serviceaccount/metrics-server created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/system:metrics-server created
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
</span></span><span class=line><span class=cl>service/metrics-server created
</span></span><span class=line><span class=cl>deployment.apps/metrics-server created
</span></span><span class=line><span class=cl>apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/microk8s-admin created
</span></span><span class=line><span class=cl>Metrics-Server is enabled
</span></span><span class=line><span class=cl>Applying manifest
</span></span><span class=line><span class=cl>serviceaccount/kubernetes-dashboard created
</span></span><span class=line><span class=cl>service/kubernetes-dashboard created
</span></span><span class=line><span class=cl>secret/kubernetes-dashboard-certs created
</span></span><span class=line><span class=cl>secret/kubernetes-dashboard-csrf created
</span></span><span class=line><span class=cl>secret/kubernetes-dashboard-key-holder created
</span></span><span class=line><span class=cl>configmap/kubernetes-dashboard-settings created
</span></span><span class=line><span class=cl>role.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span class=line><span class=cl>rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/kubernetes-dashboard created
</span></span><span class=line><span class=cl>deployment.apps/kubernetes-dashboard created
</span></span><span class=line><span class=cl>service/dashboard-metrics-scraper created
</span></span><span class=line><span class=cl>deployment.apps/dashboard-metrics-scraper created
</span></span><span class=line><span class=cl>secret/microk8s-dashboard-token created
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>If RBAC is not enabled access the dashboard using the token retrieved with:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>microk8s kubectl describe secret -n kube-system microk8s-dashboard-token
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Use this token in the https login UI of the kubernetes-dashboard service.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>In an RBAC enabled setup (microk8s enable RBAC) you need to create a user with restricted
</span></span><span class=line><span class=cl>permissions as shown in:
</span></span><span class=line><span class=cl>https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md
</span></span></code></pre></td></tr></table></div></div><p>So a bunch of stuff happened. At least <code>microk8s</code> told us what happened instead of making all of these operations under the hood which means that now we have the pleasure of figuring out what the hell just happened! On line 1, <code>microk8s</code> seems to just be searching for the repository with the desired add-on and line 2 begins the process of enabling it. This is where the fun really begins. The first step in enabling the Kubernestes dashboard is, on line 3, is to search for a repository for the <code>metrics-server</code> and begin enabling it on line 4.</p><p>Each Kubernetes node has a kubelet which is responsible for managing pod deployments and instructing the container runtime to start or stop containers are required, and the <code>metrics-server</code> scrapes resource metrics from each existing kubelet and exposes them in the Kubernetes API server via the metrics API to be used by the Horizontal and Vertical Pod Autoscalers (HPA and VPA). It should be noted that its purpose is not to serve as a monitoring solution, its metrics are to be used by HPA and VPA, but the metrics it collects do show up in the Kubernetes dashboard, so that is why it is has to be enabled. It is only after the <code>metrics-server</code> is enabled that <code>microk8s</code> will begin creating the objects required to enable the dashboard.</p><p>To access the dashboard, run <code>microk8s dashboard-proxy</code>, which outputs:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Checking if Dashboard is running.
</span></span><span class=line><span class=cl>Infer repository core for addon dashboard
</span></span><span class=line><span class=cl>Infer repository core for addon metrics-server
</span></span><span class=line><span class=cl>Waiting for Dashboard to come up.
</span></span><span class=line><span class=cl>Trying to get token from microk8s-dashboard-token
</span></span><span class=line><span class=cl>Waiting for secret token (attempt 0)
</span></span><span class=line><span class=cl>Dashboard will be available at https://127.0.0.1:10443
</span></span><span class=line><span class=cl>Use the following token to login:
</span></span><span class=line><span class=cl>[TOKEN APPEARS HERE]
</span></span></code></pre></td></tr></table></div></div><p>Just navigate to the specified page, input the token, and the dashboard is ready to use.</p><h2 id=creating-the-web-server>Creating the web server</h2><p>We are doing this in Go, so the first step is to create a directory and a Go module by running <code>go mod init</code>. In my case, since my GitHub name is <code>ornlu-is</code> and I decided to name the package <code>askeladden</code>, this equates to running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>go mod init github.com/ornlu-is/askeladden
</span></span></code></pre></td></tr></table></div></div><p>This will create a <code>go.mod</code> file that is used by Go to track the code&rsquo;s dependencies. Now we can create our <code>main.go</code> file and get to coding! The code we need to add to this file is the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>rootPathHandler</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>req</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Fprintf</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;Strange women lying in ponds distributing swords is no basis for a system of government.\n&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>rootPathHandler</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>err</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8090&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>You might be thinking: &ldquo;This web server does nothing except print out a Monty Python quote&rdquo;. Yes, that is exactly what it does. I did say this was a simple web server, and it doesn&rsquo;t get much easier than this. You can test this out by running <code>go run main.go</code> and navigating to <code>http://localhost:8090/</code>.</p><h2 id=containerizing-our-web-server>Containerizing our web server</h2><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>Docker<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>This section assumes that you have Docker installed and configured on your machine. If not, go check out the official documentation, it&rsquo;s pretty high quality.</div></div></div><p>Kubernetes is defined as being a system for automating deployment, scaling, and management of containerized applications. We have a Kubernetes cluster, we have an application, but we still need to containerize it! The first step is to write a <code>Dockerfile</code> in our root directory. I am going to be using the image for Golang 1.19, to match the version I am running locally, and have the image simply build and run the application.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Dockerfile data-lang=Dockerfile><span class=line><span class=cl><span class=k>FROM</span><span class=s> golang:1.19</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ADD</span> . /askeladden<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=s> /askeladden</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go build<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>ENTRYPOINT</span> ./askeladden<span class=err>
</span></span></span></code></pre></td></tr></table></div></div><p>But before testing this in our cluster, we should do a local sanity check to be sure everything is working as expected. Firstly, we have to build our image, which is as simple as being in the same directory of the <code>Dockerfile</code> and running</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>docker build . -f Dockerfile -t &#39;askeladden&#39;
</span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>docker build . -f Dockerfile -t 'askeladden'<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>When we give the Docker CLI the <code>build</code> command, we are telling it to build an image. Images are later used to create containers, which are instances of a given image. The <code>.</code> refers to the path of the context, which, in the context (ha-ha, funny guy) of Docker, refers to the set of files that can be used by the build process. The <code>-f</code> is shorthand notation for <code>--file</code> and is the path to the <code>Dockerfile</code>, while <code>-t</code> is short for <code>--tag</code> and allows us to name/tag our image. In this case, I only named it.</div></div></div><p>We can check our image by listing all images built by Docker using <code>docker images</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>REPOSITORY   TAG       IMAGE ID       CREATED          SIZE
</span></span><span class=line><span class=cl>askeladden   latest    8324675e97c1   57 seconds ago   1e+03MB
</span></span></code></pre></td></tr></table></div></div><p>Great, the image is there! So now we have to create and run a container based on this image to check if our web server is working. This can be achieved by running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>docker run -d -p 88:8090 askeladden
</span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>docker run -d -p 88:8090 askeladden<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>The <code>run</code> command creates and runs a container. The <code>-d</code> flag, which stands for <code>--detach</code>, will run the container in the background of the terminal, meaning it will not block the terminal window. Since the container has its own network, we have to expose the port <code>8090</code> where our web server can be accessed inside the container to outside the container. This is achieved by publishing the port and mapping it into a port on the host machine, <em>i.e.</em>, my computer, with the <code>-p</code> flag followed by the specification of the host port and container port in the <code>&lt;host_port>:&lt;container_port></code> format. Finally, we specify the name of the image we want to build our container from which, in this case, is just <code>askeladden</code>. Docker will first look for this image locally and, if it doesn&rsquo;t find it, it will attempt to retrieve it from a public image repository.</div></div></div><p>We can see the list of running containers by typing <code>docker ps</code>, and we can check that it is properly running by navigating to <code>http://localhost:88/</code>. So, now we&rsquo;re fairly certain that our web server is containerized as desired, so we can stop the container using the <code>docker stop &lt;container_ID></code> command (you can retrieve the container ID from the output of <code>docker ps</code>).</p><p>Now the output of <code>docker ps</code> doesn&rsquo;t show anything but the container wasn&rsquo;t actually deleted, it was merely stopped. If we type <code>docker ps -a</code>, where <code>-a</code> stands for <code>--all</code>, we can see that our container is in an <code>Exited</code> status. To avoid taking up resources, let&rsquo;s just delete it with <code>docker rm &lt;container_ID></code>.</p><h2 id=creating-a-kubernetes-namespace>Creating a Kubernetes Namespace</h2><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>Kubernetes dashboard<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>In this section, most, if not all, of the commands that I will run that <code>get</code> or <code>describe</code> a given Kubernetes objectives can be replaced by using the Kubernetes dashboard that was previously enabled. But it will not make you look as cool as if you did everything in the terminal.</div></div></div><p>We want to deploy the web server into our cluster in a way that isolates it from the remaining pods that are running in it, which means that we have to deploy it into a separate namespace. To get a list of what namespaces are already configured on the cluster, we can simply run <code>mk get namespaces</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME              STATUS   AGE
</span></span><span class=line><span class=cl>kube-system       Active   23h
</span></span><span class=line><span class=cl>kube-public       Active   23h
</span></span><span class=line><span class=cl>kube-node-lease   Active   23h
</span></span><span class=line><span class=cl>default           Active   23h
</span></span></code></pre></td></tr></table></div></div><p>We can see that there are several namespaces whose name starts with <code>kube</code>, meaning that these are Kubernetes system namespaces and we do not want to tinker with those, at least for now. We could deploy our web server to the <code>default</code> namespace (which would be where it would go if we did not specify any namespace), but it will be helpful in the future to have this running in its own namespace.</p><p>So, let&rsquo;s start creating Kubernetes definition files! Create a directory called <code>k8s</code> and a file inside it named <code>namespace.yaml</code> with the following content:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>askeladden-dev</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>To create a Kubernetes object from a <code>.yaml</code> file, all we have to do is run</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk create -f k8s/namespaces.yaml
</span></span></code></pre></td></tr></table></div></div><p>We can easily check if it has been created by running <code>mk get namespaces</code> again:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME              STATUS   AGE
</span></span><span class=line><span class=cl>kube-system       Active   23h
</span></span><span class=line><span class=cl>kube-public       Active   23h
</span></span><span class=line><span class=cl>kube-node-lease   Active   23h
</span></span><span class=line><span class=cl>default           Active   23h
</span></span><span class=line><span class=cl>askeladden-dev    Active   5h51m
</span></span></code></pre></td></tr></table></div></div><p>However, Kubernetes objects will still be created into the <code>default</code> namespace if the target namespace is not specified. Again, in typical software engineering fashion, we will go to great lengths to save a few keystrokes.</p><p>We can check our Kubernetes config with <code>mk config view</code> to look for what contexts are configured. Contexts are merely aliases for cluster parameters to make our lives easier.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>DATA+OMITTED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://127.0.0.1:16443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>microk8s-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>microk8s-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>microk8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>microk8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>REDACTED</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>There is only one context, <code>microk8s</code>, so it is obvious which context we are using. But if it weren&rsquo;t as obvious, we could get that information by running</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk config current-context
</span></span></code></pre></td></tr></table></div></div><p>The context that we are using by default does not have any namespace associated with which means, you&rsquo;ve guessed it, the namespace that we default to is the <code>default</code> namespace. This also means we have to create our own context, which can be readily achieve through:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk config set-context askeladden-dev --namespace=askeladden-dev --cluster=microk8s-cluster --user=admin
</span></span></code></pre></td></tr></table></div></div><p>It is simply a context that, when used, will automatically fill unspecified cluster parameters with the ones in the context. We can now see that our <code>config</code> has a new context:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>clusters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>certificate-authority-data</span><span class=p>:</span><span class=w> </span><span class=l>DATA+OMITTED</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>https://127.0.0.1:16443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>microk8s-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>contexts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>microk8s-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>askeladden-dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>askeladden-dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>context</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>cluster</span><span class=p>:</span><span class=w> </span><span class=l>microk8s-cluster</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>user</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>microk8s</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>current-context</span><span class=p>:</span><span class=w> </span><span class=l>askeladden-dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>preferences</span><span class=p>:</span><span class=w> </span>{}<span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>users</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>user</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>token</span><span class=p>:</span><span class=w> </span><span class=l>REDACTED</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>All that is needed is to switch to it using:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk config use-context askeladden-dev
</span></span></code></pre></td></tr></table></div></div><p>The context? <code>askeladden-dev</code>. The keystrokes? 20% less. Great success.</p><h2 id=deploying-our-containerized-web-server-into-our-kubernetes-cluster>Deploying our containerized web server into our Kubernetes cluster</h2><p>So what is running in the namespace we just created? We can figure this out by running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk get all
</span></span></code></pre></td></tr></table></div></div><p>Which readily lets us know that</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>No resources found in askeladden-dev namespace.
</span></span></code></pre></td></tr></table></div></div><p>There is one issue that I haven&rsquo;t addressed yet. We built the container image locally, but the cluster does not have access to the Docker daemon that is running on my machine and thus it cannot use the image we have built to create the container. To first step to taking care of this is to enable the registry in <code>microk8s</code> via:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s enable registry
</span></span></code></pre></td></tr></table></div></div><p>Which outputs the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Infer repository core for addon registry
</span></span><span class=line><span class=cl>Infer repository core for addon hostpath-storage
</span></span><span class=line><span class=cl>Enabling default storage class.
</span></span><span class=line><span class=cl>WARNING: Hostpath storage is not suitable for production environments.
</span></span><span class=line><span class=cl>deployment.apps/hostpath-provisioner created
</span></span><span class=line><span class=cl>storageclass.storage.k8s.io/microk8s-hostpath created
</span></span><span class=line><span class=cl>serviceaccount/microk8s-hostpath created
</span></span><span class=line><span class=cl>clusterrole.rbac.authorization.k8s.io/microk8s-hostpath created
</span></span><span class=line><span class=cl>clusterrolebinding.rbac.authorization.k8s.io/microk8s-hostpath created
</span></span><span class=line><span class=cl>Storage will be available soon.
</span></span><span class=line><span class=cl>The registry will be created with the size of 20Gi.
</span></span><span class=line><span class=cl>Default storage class will be used.
</span></span><span class=line><span class=cl>namespace/container-registry created
</span></span><span class=line><span class=cl>persistentvolumeclaim/registry-claim created
</span></span><span class=line><span class=cl>deployment.apps/registry created
</span></span><span class=line><span class=cl>service/registry created
</span></span><span class=line><span class=cl>configmap/local-registry-hosting configured
</span></span></code></pre></td></tr></table></div></div><p>Again, a bunch of stuff happened. <code>microk8s</code> created all the objects required to have its own registry. So now we have to push our local image into the registry that is in the cluster, so that <code>microk8s</code> can use that image to create our container.</p><p>For that matter, we first get our image ID from the output of <code>docker images</code>, and then we tag it with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>docker tag &lt;image_ID&gt; localhost:32000/askeladden:registry
</span></span></code></pre></td></tr></table></div></div><p>Note that <code>localhost:32000</code> is a port on our host machine that is connected to the cluster&rsquo;s registry. Now all that is left to do is to push this image into the registry with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>docker push localhost:32000/askeladden:registry
</span></span></code></pre></td></tr></table></div></div><p>Now we are ready to deploy our container to the cluster! All that we need now is to create a Kubernetes definition file <code>k8s/deployment.yaml</code>, with the following contents:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>deployment-askeladden-dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>askeladden</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>askeladden</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>askeladden</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>localhost:32000/askeladden:registry</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>This will create three different Kubernetes objects: a <code>Pod</code> with our container running inside it, a <code>ReplicaSet</code> which ensures that we always have a given number of copies of the <code>Pod</code> running (in this case, it&rsquo;s just one), and a <code>Deployment</code> object, which handles how <code>Pod</code>s are updated, rolled out, scaled, etc. We can see all of these objects by running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk get all
</span></span></code></pre></td></tr></table></div></div><p>Which outputs this OCD triggering table formatted result:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME                                             READY   STATUS    RESTARTS   AGE
</span></span><span class=line><span class=cl>pod/deployment-askeladden-dev-75c45dc7d9-r9hcf   1/1     Running   0          78s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                        READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class=line><span class=cl>deployment.apps/deployment-askeladden-dev   1/1     1            1           78s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>NAME                                                   DESIRED   CURRENT   READY   AGE
</span></span><span class=line><span class=cl>replicaset.apps/deployment-askeladden-dev-75c45dc7d9   1         1         1       78s
</span></span></code></pre></td></tr></table></div></div><p>But (there&rsquo;s always a &ldquo;but&rdquo;), our web server is running inside the container, which is inside the pod, which is inside the cluster. We cannot access it as we have before because we have not exposed a port in the cluster with which to communicate with the server. To solve this, we have to create a Kubernetes <code>Service</code> of the <code>NodePort</code> kind (this is not the only option, it is just the option I felt like doing right now). As before, we create a new Kubernetes definition file, <code>k8s/service.yaml</code>, with the following contents:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>askeladden-dev-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>askeladden</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8090</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30008</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>askeladden</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>There are a few things to note here. The <code>targetPort</code> is the port on the <code>Pod</code> that we want to expose. In our cause, this is where the web server is running, so it is <code>8090</code>. The <code>port</code> is the port on the <code>Service</code> that connects to the <code>targetPort</code>. Finally, the <code>nodePort</code> is the port of the node that is exposed to the outside world. The <code>Service</code> searches for <code>Pod</code>s with labels matching those given under <code>selector</code> and exposes their <code>targetPort</code> via the <code>nodePort</code>.</p><p>After creating the service the usual way, we can new see a new Kubernetes object in our namespace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME                             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
</span></span><span class=line><span class=cl>service/askeladden-dev-service   NodePort   10.152.183.55   &lt;none&gt;        80:30008/TCP   3s
</span></span></code></pre></td></tr></table></div></div><h2 id=future-overengineering-steps>Future Overengineering Steps</h2><p>It&rsquo;s all about saving those precious keystrokes, and there are two major keystroke consumers as of now:</p><ul><li>Having to push the Docker images into the cluster&rsquo;s registry manually;</li><li>Having to create the Kubernetes objects manually.</li></ul><p>So the next objective might be to reduce one of those. Maybe. I don&rsquo;t know.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-15</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/go/>go</a>,&nbsp;<a href=/tags/kubernetes/>kubernetes</a>,&nbsp;<a href=/tags/docker/>docker</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Luís Franco</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>