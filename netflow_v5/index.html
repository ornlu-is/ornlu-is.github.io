<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G300HG9GRT"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G300HG9GRT")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Understanding Netflow v5 - Luís Franco</title><meta name=Description content="An overview of the NetFlow v5 protocol"><meta property="og:title" content="Understanding Netflow v5">
<meta property="og:description" content="An overview of the NetFlow v5 protocol"><meta property="og:type" content="article"><meta property="og:url" content="https://ornlu-is.github.io/netflow_v5/"><meta property="og:image" content="https://ornlu-is.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-13T18:54:40+01:00"><meta property="article:modified_time" content="2023-08-14T08:31:16+01:00"><meta property="og:site_name" content="Super website"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ornlu-is.github.io/logo.png"><meta name=twitter:title content="Understanding Netflow v5"><meta name=twitter:description content="An overview of the NetFlow v5 protocol"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ornlu-is.github.io/netflow_v5/><link rel=prev href=https://ornlu-is.github.io/docker_compose_promtail_loki_grafana/><link rel=next href=https://ornlu-is.github.io/go_slices/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Understanding Netflow v5","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ornlu-is.github.io\/netflow_v5\/"},"genre":"posts","wordcount":1294,"url":"https:\/\/ornlu-is.github.io\/netflow_v5\/","datePublished":"2023-08-13T18:54:40+01:00","dateModified":"2023-08-14T08:31:16+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Luís Franco"},"description":"An overview of the NetFlow v5 protocol"}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></span></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Understanding Netflow v5</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Luís Franco</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/computer-networks/><i class="far fa-folder fa-fw" aria-hidden=true></i>Computer Networks</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-08-13>2023-08-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1294 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#the-netflow-v5-datagram>The NetFlow v5 datagram</a></li><li><a href=#header-datagram-specification>Header datagram specification</a></li><li><a href=#flow-datagram-specification>Flow datagram specification</a></li><li><a href=#some-considerations-on-using-netflow-v5-for-analytics>Some considerations on using NetFlow v5 for analytics</a></li></ul></nav></div></div><div class=content id=content><p>NetFlow is a protocol developed by Cisco that has had several iterations over the years. This network protocol&rsquo;s main focus is to collect IP traffic information and export it for monitoring purposes. A router configured to collect NetFlow will aggregate data packets into what is known as a flow, which is basically a summary of the traffic passing through the device in a given time span. Of the multiple iterations of the NetFlow protocol that Cisco has produced, two have cemented themselves as the most commonly used protocols: NetFlow v5 and NetFlow v9. Today, I&rsquo;ll focus on the NetFlow v5 description.</p><h2 id=the-netflow-v5-datagram>The NetFlow v5 datagram</h2><p>When a device is configured to collect and send (which is usually performed via UDP) flow data according to the NetFlow v5 protocol, that device will periodically send NetFlow v5 datagrams which as composed of a header and a variable number of flows, as depicted in the image below:</p><figure><img src=/images/netflow_v5/netflow_v5_datagram.png width=0.5 height=0.5><figcaption><h4>NetFlow v5 datagram</h4></figcaption></figure><p>Meaning that for each UDP packet you receive from your collecting device, you might get several flows worth of information.</p><h2 id=header-datagram-specification>Header datagram specification</h2><p>The NetFlow v5 header is composed of 24 bytes, with each byte corresponding to the following information:</p><table><thead><tr><th style=text-align:left>Bytes</th><th style=text-align:left>Field</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>0-1</td><td style=text-align:left><code>version</code></td><td style=text-align:left>NetFlow export format version number</td></tr><tr><td style=text-align:left>2-3</td><td style=text-align:left><code>count</code></td><td style=text-align:left>Number of flows exported in this packet</td></tr><tr><td style=text-align:left>4-7</td><td style=text-align:left><code>SysUptime</code></td><td style=text-align:left>Current time in milliseconds since the export device booted</td></tr><tr><td style=text-align:left>8-11</td><td style=text-align:left><code>unix_secs</code></td><td style=text-align:left>Current count of seconds since 0000 UTC 1970</td></tr><tr><td style=text-align:left>12-15</td><td style=text-align:left><code>unix_nsecs</code></td><td style=text-align:left>Residual nanoseconds since 0000 UTC 1970</td></tr><tr><td style=text-align:left>16-19</td><td style=text-align:left><code>flow_sequence</code></td><td style=text-align:left>Sequence counter of total flows seen</td></tr><tr><td style=text-align:left>20</td><td style=text-align:left><code>engine_type</code></td><td style=text-align:left>Type of flow-switching engine</td></tr><tr><td style=text-align:left>21</td><td style=text-align:left><code>engine_id</code></td><td style=text-align:left>Slot number of the flow-switching engine</td></tr><tr><td style=text-align:left>22-23</td><td style=text-align:left><code>sampling_interval</code></td><td style=text-align:left>First two bits hold the sampling mode; remaining 14 bits hold value of sampling interval</td></tr></tbody></table><p>While some of these fields may seem obvious, other require a bit more clarification. Obviously, since we are dealing with NetFlow v5, the <code>version</code> field will always correspond to the number five. The <code>count</code> field, while it is made out of two bytes, which might lead some to deduce that it is a number between zero and 65,536, this is not the case. In fact, the maximum number of flow in each NetFlow v5 datagram is 30.</p><p>The <code>engine_type</code> field provides an identifier of how the collecting device handles flow-switching. Since NetFlow v5 is a proprietary protocol from Cisco, this is mapped into a Cisco-specific flow-switching technology. For monitoring purposes, this field requires a great deal of understanding of the underlying Cisco technologies and how your devices are configured to extract any type of meaningful information. For that reason, flow monitoring services tend to ignore this field. The <code>engine_id</code> field is a configurable identifier for the flow collector.</p><p>Finally, the last field that requires a bit more understanding is the <code>sampling_interval</code>. A NetFlow collector doesn&rsquo;t necessarily export flows that contain absolutely exact information on the observed traffic. For devices that handle large loads, this is usually not computationally efficient. As such, NetFlow collectors can be configured to employ sampling, where the flows will be calculated based on a reduced sample of the network&rsquo;s IP traffic. Broadly speaking, there are two main sampling modes:</p><ul><li>Sampled NetFlow - flows are calculated based on x-th packet, <em>i.e.</em>, if this is set to an interval of 10, then the flows reported contain are calculated based on the 1st, 10th, 20th, etc., packets. This sampling method is usually advised against, since it might hide periodic traffic patterns;</li><li>Random Sampled NetFlow - flows are calculated based on random draws of incoming packets, much like random sampling. It provides on average consistency on the number of packets used to calculate the flows and is overall more statistically accurate than the Sampled NetFlow scheme.</li></ul><h2 id=flow-datagram-specification>Flow datagram specification</h2><p>The flow datagram is a fair bit larger than the header, with each flow containing 48 bytes of data organised as follows:</p><table><thead><tr><th style=text-align:left>Bytes</th><th style=text-align:left>Field</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>0-3</td><td style=text-align:left><code>srcaddr</code></td><td style=text-align:left>Source IP address</td></tr><tr><td style=text-align:left>4-7</td><td style=text-align:left><code>dstaddr</code></td><td style=text-align:left>Destination IP address</td></tr><tr><td style=text-align:left>8-11</td><td style=text-align:left><code>nexthop</code></td><td style=text-align:left>IP address of next hop router</td></tr><tr><td style=text-align:left>12-13</td><td style=text-align:left><code>input</code></td><td style=text-align:left>SNMP index of input interface</td></tr><tr><td style=text-align:left>14-15</td><td style=text-align:left><code>output</code></td><td style=text-align:left>SNMP index of output interface</td></tr><tr><td style=text-align:left>16-19</td><td style=text-align:left><code>dPkts</code></td><td style=text-align:left>Packets in the flow</td></tr><tr><td style=text-align:left>20-23</td><td style=text-align:left><code>dOctets</code></td><td style=text-align:left>Total number of Layer 3 bytes in the packets of the flow</td></tr><tr><td style=text-align:left>24-27</td><td style=text-align:left><code>First</code></td><td style=text-align:left>SysUptime at start of flow</td></tr><tr><td style=text-align:left>28-31</td><td style=text-align:left><code>Last</code></td><td style=text-align:left>SysUptime at the time the last packet of the flow was received</td></tr><tr><td style=text-align:left>32-33</td><td style=text-align:left><code>srcport</code></td><td style=text-align:left>TCP/UDP source port number or equivalent</td></tr><tr><td style=text-align:left>34-35</td><td style=text-align:left><code>dstport</code></td><td style=text-align:left>TCP/UDP destination port number or equivalent</td></tr><tr><td style=text-align:left>36</td><td style=text-align:left><code>pad1</code></td><td style=text-align:left>Unused (zero) bytes</td></tr><tr><td style=text-align:left>37</td><td style=text-align:left><code>tcp_flags</code></td><td style=text-align:left>Cumulative OR of TCP flags</td></tr><tr><td style=text-align:left>38</td><td style=text-align:left><code>prot</code></td><td style=text-align:left>IP protocol type</td></tr><tr><td style=text-align:left>39</td><td style=text-align:left><code>tos</code></td><td style=text-align:left>IP type of service (ToS)</td></tr><tr><td style=text-align:left>40-41</td><td style=text-align:left><code>src_as</code></td><td style=text-align:left>Autonomous system number of the source, either origin or peer</td></tr><tr><td style=text-align:left>42-43</td><td style=text-align:left><code>dst_as</code></td><td style=text-align:left>Autonomous system number of the destination, either origin or peer</td></tr><tr><td style=text-align:left>44</td><td style=text-align:left><code>src_mask</code></td><td style=text-align:left>Source address prefix mask bits</td></tr><tr><td style=text-align:left>45</td><td style=text-align:left><code>dst_mask</code></td><td style=text-align:left>Destination address prefix mask bits</td></tr><tr><td style=text-align:left>46-47</td><td style=text-align:left><code>pad2</code></td><td style=text-align:left>Unused (zero) bytes</td></tr></tbody></table><p>Let us clarify some of these fields. As you might&rsquo;ve already noticed, the <code>srcaddr</code> and <code>dstaddr</code> fields, which correspond, respectively, to the source and destination IP addresses of the traffic, are only four bytes long. This means that NetFlow v5 is limited uniquely to IPv4 traffic, which is a testament to the fact that it was released a long time ago.</p><p>The <code>tcp_flags</code> field is a single byte used to represent TCP flags via a cumulative OR. If you are not familiar with TCP, it is sufficient to understand that each TCP datagram contains information on the TCP flags, which describe what operation or outcome was performed/observed. There are eight possible flags, which makes it fairly straight-forward to one-hot encode these. Then, to get a single byte representation of all possible combinations, we simply take the cumulative OR function of their bytes.</p><p>One of the most important fields in NetFlow v5 is the <code>prot</code> field, which pertains to the possible protocol. While it might seem confusing that the protocol is a single number, we can easily get the corresponding name via the mapping published by the Internet Assigned Numbers Authority (IANA).</p><h2 id=some-considerations-on-using-netflow-v5-for-analytics>Some considerations on using NetFlow v5 for analytics</h2><p>There are two major considerations to take when building analytics with NetFlow v5. The first one is to understand that a flow is not an instant snapshot of your traffic. It is a summary of your traffic, collected over a given period of time, which is where the <code>First</code> and <code>Last</code> fields come in. These allow you to know for how long was data collected to calculate the given flow. However, you get absolutely no information on how the traffic was distributed inside that time range. This means that you have to make an assumption. A sensible one is to assume that, for short flow collection periods, traffic was more or less constant and, as such, you can uniformly distribute it across the time granularity you are using. There is nothing stopping you from considering more complicated schemes, but know that there is very little to gain from not taking the uniformly distributed approach.</p><p>The last consideration pertains to the <code>sampling_interval</code>. This value is basically the inverse of a sampling rate applied by the flow collector, and it is important because you cannot calculate the amount of bytes or packets in a flow without it. If a flow has <code>dOctets = 24</code> and the header has <code>sampling_interval=10</code>, then the number of bytes you have to report is 240, because your flow was calculated using only 10% of your network&rsquo;s traffic. You will obviously incur in an approximation error with this, but your scope of operation is after the flow is collected, so you have no control over its sampling strategy. And even if you had, keep in mind that flow exports have to be produced at very high speeds and with minimal computational effort, which immediately discards the vast majority, if not all, sampling schemes that are not simple random sampling.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-08-14</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/docker_compose_promtail_loki_grafana/ class=prev rel=prev title="Hooking Promtail, Loki, and Grafana to your Docker Compose stack"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Hooking Promtail, Loki, and Grafana to your Docker Compose stack</a>
<a href=/go_slices/ class=next rel=next title="A deep dive on Golang slices">A deep dive on Golang slices<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Luís Franco</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>