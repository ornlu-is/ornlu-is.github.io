<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G300HG9GRT"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G300HG9GRT")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Enforcing test coverage in Go with Makefile - Luís Franco</title><meta name=Description content="This is my cool site"><meta property="og:title" content="Enforcing test coverage in Go with Makefile"><meta property="og:description" content="Makefiles are a popular way of making the development process easier, since they can be used to chain several commands that allow developers to build, test, run, etc. their code. Additionally, they can also be used to create a make-based build/test system. In this post, I&rsquo;m going to cover something how to set up a Makefile rule to test Golang code and enforce test coverage, i.e., have the rule fail if a predefined test coverage threshold is not met."><meta property="og:type" content="article"><meta property="og:url" content="https://ornlu-is.github.io/go_makefile_code_coverage/"><meta property="og:image" content="https://ornlu-is.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-17T23:22:19+01:00"><meta property="article:modified_time" content="2023-08-17T23:31:20+01:00"><meta property="og:site_name" content="Super website"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ornlu-is.github.io/logo.png"><meta name=twitter:title content="Enforcing test coverage in Go with Makefile"><meta name=twitter:description content="Makefiles are a popular way of making the development process easier, since they can be used to chain several commands that allow developers to build, test, run, etc. their code. Additionally, they can also be used to create a make-based build/test system. In this post, I&rsquo;m going to cover something how to set up a Makefile rule to test Golang code and enforce test coverage, i.e., have the rule fail if a predefined test coverage threshold is not met."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ornlu-is.github.io/go_makefile_code_coverage/><link rel=prev href=https://ornlu-is.github.io/go_design_pattern_generator/><link rel=next href=https://ornlu-is.github.io/go_fan_in_pattern/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Enforcing test coverage in Go with Makefile","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ornlu-is.github.io\/go_makefile_code_coverage\/"},"genre":"posts","wordcount":704,"url":"https:\/\/ornlu-is.github.io\/go_makefile_code_coverage\/","datePublished":"2023-08-17T23:22:19+01:00","dateModified":"2023-08-17T23:31:20+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Luís Franco"},"description":""}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></span></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Enforcing test coverage in Go with Makefile</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Luís Franco</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/golang/><i class="far fa-folder fa-fw" aria-hidden=true></i>Golang</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-08-17>2023-08-17</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;704 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#tldr-just-let-me-copy-it>TL;DR, just let me copy it</a></li><li><a href=#okay-i-regret-just-copying-it-how-does-this-work>Okay, I regret just copying it, how does this work?</a></li></ul></nav></div></div><div class=content id=content><p>Makefiles are a popular way of making the development process easier, since they can be used to chain several commands that allow developers to build, test, run, etc. their code. Additionally, they can also be used to create a make-based build/test system. In this post, I&rsquo;m going to cover something how to set up a Makefile rule to test Golang code and enforce test coverage, <em>i.e.</em>, have the rule fail if a predefined test coverage threshold is not met.</p><h2 id=tldr-just-let-me-copy-it>TL;DR, just let me copy it</h2><p>Let us take a look at the Makefile and then we&rsquo;ll walk through it step by step:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-Makefile data-lang=Makefile><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/bash
</span></span><span class=line><span class=cl><span class=nv>TEST_COVERAGE_THRESHOLD</span><span class=o>=</span>80.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nf>test</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    go <span class=nb>test</span> ./... -coverprofile<span class=o>=</span>coverage.out 
</span></span><span class=line><span class=cl>    <span class=nv>coverage</span><span class=o>=</span><span class=nv>$$</span><span class=o>(</span>go tool cover -func<span class=o>=</span>coverage.out <span class=p>|</span> grep total <span class=p>|</span> grep -Eo <span class=s1>&#39;[0-9]+\.[0-9]+&#39;</span><span class=o>)</span> <span class=p>;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    rm coverage.out <span class=p>;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>if</span> <span class=o>[</span> <span class=nv>$$</span><span class=o>(</span>bc <span class=o>&lt;&lt;&lt;</span> <span class=s2>&#34;</span><span class=nv>$$</span><span class=s2>coverage &lt; </span><span class=k>$(</span>TEST_COVERAGE_THRESHOLD<span class=k>)</span><span class=s2>&#34;</span><span class=o>)</span> -eq <span class=m>1</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=nb>echo</span> <span class=s2>&#34;Low test coverage: </span><span class=nv>$$</span><span class=s2>coverage &lt; </span><span class=k>$(</span>TEST_COVERAGE_THRESHOLD<span class=k>)</span><span class=s2>&#34;</span> <span class=p>;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>        <span class=nb>exit</span> <span class=m>1</span> <span class=p>;</span><span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    <span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=okay-i-regret-just-copying-it-how-does-this-work>Okay, I regret just copying it, how does this work?</h2><p>The first two lines are defining global variables. The <code>SHELL</code> variable is present in all Makefiles and specifies which shell we are using. By default, Makefile uses <code>sh</code> but we want more functionalities so we want our Makefile to use <code>bash</code>, so we place the path to <code>bash</code> in our <code>SHELL</code> variable. The second variable is our desired minimum test coverage, <em>i.e.</em>, the value below which our make rule should fail.</p><p>Line 4 simply specifies the rule name, and is followed by its definition. We want to keep our Makefile simple and intuitive, so we name our rule <code>test</code>, meaning that this can be ran by writing <code>make test</code>.</p><p>On line 5 we test our Go code. In case any test fails, our rule execution terminates promptly, printing the test report. <code>./...</code> tells the <code>go</code> tool to recursively look for test files in our project directory and run all files of the format <code>*_test.go</code>. Finally, the <code>-coverprofile=coverage.out</code>, outputs the test coverage profile into a file called <code>coverage.out</code>. We do not directly care about what is written in this file.</p><p>Line 6 is where we make use of the <code>coverage.out</code> file. By running <code>go tool cover -func=coverage.out</code> we now calculate the percentage of test coverage for each function as well as the total coverage of our project. We are defining a simple global threshold, so we have to extract only the line of the pertaining to the total coverage. Fortunately, since this line starts with <code>total</code>, we can simply pipe the result from <code>go tool cover -func=coverage.out</code> into <code>grep</code> and tell it to extract the line containing that string using <code>grep total</code>. However, this line still needs a bit more processing since we have to remove everything except for the percentage of total coverage. In comes <code>grep</code> once again, we just pipe the result of the previous <code>grep</code> command to <code>grep -Eo '[0-9]+\.[0-9]+'</code>, where the <code>E</code> flag tells <code>grep</code> that our pattern is a regular expression, and the <code>o</code> flag is to guarantee we fetch only nonempty parts of the result. Finally, we save all of this in a local <code>coverage</code> variable.</p><p>Since we no longer have any use for our <code>coverage.out</code> file, we can safely delete it in line 7 using <code>rm coverage.out</code>.</p><p>On Line 8, we check if the our test coverage is lower than our defined threshold. Both the obtained test coverage and the test coverage threshold are given as floating point numbers, which means that they cannot be natively compared when using <code>bash</code>. However, we can use <code>bc</code> for this purpose. <code>bc</code> stands for basic calculator and, if given a condition, it returns 1 if that confition is true and 0 otherwise. Which means that all that is left is check if the output we obtain from <code>bc</code> is equal to 1, which is achieved through <code>-eq 1</code>.</p><p>On lines 9 and 10, we print an informative message that the test coverage is too low and terminate the rule execution with error code 1. On the last line, we close our <code>if</code> block.</p><p>It took me more time than I care to admit to find out how to do this, so I am writting it down so I do not forget it.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-08-17</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/go_design_pattern_generator/ class=prev rel=prev title="Go Design Patterns: Generator"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Go Design Patterns: Generator</a>
<a href=/go_fan_in_pattern/ class=next rel=next title="Go Concurrency Patterns: Fan-In">Go Concurrency Patterns: Fan-In<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Luís Franco</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>