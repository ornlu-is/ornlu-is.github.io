<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G300HG9GRT"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G300HG9GRT")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Adventures in Overengineering 4: using Terraform for Kubernetes namespace creation - Luís Franco</title><meta name=Description content="Using Terraform to create a Kubernetes namespace in a local microk8s cluster and migrating a Kubernetes application to it using Helm"><meta property="og:title" content="Adventures in Overengineering 4: using Terraform for Kubernetes namespace creation"><meta property="og:description" content="Using Terraform to create a Kubernetes namespace in a local microk8s cluster and migrating a Kubernetes application to it using Helm"><meta property="og:type" content="article"><meta property="og:url" content="https://ornlu-is.github.io/overengineering_adventures_4/"><meta property="og:image" content="https://ornlu-is.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-29T22:57:58+01:00"><meta property="article:modified_time" content="2023-03-30T13:42:58+01:00"><meta property="og:site_name" content="Super website"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ornlu-is.github.io/logo.png"><meta name=twitter:title content="Adventures in Overengineering 4: using Terraform for Kubernetes namespace creation"><meta name=twitter:description content="Using Terraform to create a Kubernetes namespace in a local microk8s cluster and migrating a Kubernetes application to it using Helm"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ornlu-is.github.io/overengineering_adventures_4/><link rel=prev href=https://ornlu-is.github.io/overengineering_adventures_3/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Adventures in Overengineering 4: using Terraform for Kubernetes namespace creation","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ornlu-is.github.io\/overengineering_adventures_4\/"},"genre":"posts","wordcount":2484,"url":"https:\/\/ornlu-is.github.io\/overengineering_adventures_4\/","datePublished":"2023-03-29T22:57:58+01:00","dateModified":"2023-03-30T13:42:58+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Luís Franco"},"description":"Using Terraform to create a Kubernetes namespace in a local microk8s cluster and migrating a Kubernetes application to it using Helm"}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></span></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Adventures in Overengineering 4: using Terraform for Kubernetes namespace creation</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Luís Franco</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/adventures-in-overengineering/><i class="far fa-folder fa-fw" aria-hidden=true></i>Adventures in Overengineering</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-03-29>2023-03-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;2484 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;12 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#what-is-terraform>What is Terraform?</a></li><li><a href=#setting-up-terraform-with-a-local-kubernetes-cluster>Setting up Terraform with a local Kubernetes cluster</a></li><li><a href=#creating-the-necessary-files-to-create-a-kubernetes-namespace-with-terraform>Creating the necessary files to create a Kubernetes namespace with Terraform</a></li><li><a href=#using-terraform>Using Terraform</a></li><li><a href=#re-deploying-the-web-server-in-the-newly-created-namespace>Re-deploying the web server in the newly created namespace</a></li></ul></nav></div></div><div class=content id=content><p>This post has one very simple and short goal: to use Terraform to create a Kubernetes namespace to which we will migrate the application that we&rsquo;ve been working on. Now, you might ask yourself: &ldquo;Is it overkill to use Terraform just to create Kubernetes namespaces?&rdquo; To which the answer is: yes, yes it is. But will that stop me? Short answer &ldquo;no&rdquo;, long answer &ldquo;no, it will not&rdquo;. The name of the series is &ldquo;<em>Adventures in Overengineering</em>&rdquo; and I plan to remain faithful to that name until I run out of ideas.</p><div class="details admonition tip open"><div class="details-summary admonition-title"><i class="icon fas fa-lightbulb fa-fw" aria-hidden=true></i>Link to the code<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><a href=https://github.com/ornlu-is/askeladden/tree/v0.4 target=_blank rel="noopener noreffer">https://github.com/ornlu-is/askeladden/tree/v0.4</a></div></div></div><h2 id=what-is-terraform>What is Terraform?</h2><p>A concept that quickly rose to popularity in recent times is the concept of infrastructure as code, IaC, where, as the name suggests, infrastructure is managed and provisioned via code instead of manual processes. This has a number of advantages, such as being able to fully leverage a version control system to track, and possibly rollback, infrastructure. Naturally, it also makes distributing infrastructure configuration across developers and teams much easier. One popular tool for this paradigm, is Terraform, which takes a declarative approach to IaC, by allowing developers to write files which declare the currently desired state of the infrastructure. There are many other technologies that can be used for this purpose, but Terraform is the one I am used to using, so that is what I&rsquo;m going to go with.</p><h2 id=setting-up-terraform-with-a-local-kubernetes-cluster>Setting up Terraform with a local Kubernetes cluster</h2><p>First things first, we have to install Terraform. For that matter, we can simply follow the <a href=https://developer.hashicorp.com/terraform/docs target=_blank rel="noopener noreffer">official documentation</a>
, which happens to be very straightforward. Now we just need one last step before we are good to go. Since I am using <code>microk8s</code>, its configuration isn&rsquo;t saved under <code>~/.kube/config</code>. We can take care of this with one simple command:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s config &gt; ~/.kube/config
</span></span></code></pre></td></tr></table></div></div><p>And we are done, installation-wise. That was quick.</p><h2 id=creating-the-necessary-files-to-create-a-kubernetes-namespace-with-terraform>Creating the necessary files to create a Kubernetes namespace with Terraform</h2><p>We will be using Terraform for managing infrastructure, which means that the files we create for this purpose already have one natural destination: our <code>infrastructure/</code> directory. We create a new directory inside <code>infrastructure</code>, called <code>terraform</code>, and populate it with the following files:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>terraform/
</span></span><span class=line><span class=cl>├── backend.tf
</span></span><span class=line><span class=cl>├── main.tf
</span></span><span class=line><span class=cl>├── provider.tf
</span></span><span class=line><span class=cl>└── versions.tf
</span></span></code></pre></td></tr></table></div></div><p>Let us go over these one by one, starting with <code>backend.tf</code>, which, as the name suggests, specifies what backend terraform should use for remote state management and state locking. In this case, we will be using the <code>kubernetes</code> backend, which stores the Terraform state as a Kubernetes secret:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>backend</span> <span class=s2>&#34;kubernetes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>secret_suffix</span>   = <span class=s2>&#34;state&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>config_path</span>     = <span class=s2>&#34;~/.kube/config&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>namespace</span>       = <span class=s2>&#34;terraform&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>If we look at the Terraform documentation for this backend type, we see that this backend is limited by Kubernetes maximum secret size, which is 1MB. This might be troublesome in the future but for now, our mindset is going to be &ldquo;if it breaks, it breaks&rdquo; and then we&rsquo;ll fix it when necessary. Since we are using the Kubernetes backend and we want to use Terraform to create a Kubernetes namespace, we also need to specify a provider, in <code>provider.tf</code>, which, in the Terraform nomenclature, is a set of plugins to interact with resources:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>provider</span> <span class=s2>&#34;kubernetes&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=na>config_path</span>       = <span class=s2>&#34;~/.kube/config&#34;</span>
</span></span><span class=line><span class=cl>  <span class=na>config_context</span>    = <span class=s2>&#34;microk8s&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Providers are plugins and plugins have different versions depending on the underlying API they interact with, which means that we should specify the provider version we want in <code>versions.tf</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=nx>terraform</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>required_providers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>kubernetes</span> = <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=na>source</span> = <span class=s2>&#34;hashicorp/kubernetes&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>I didn&rsquo;t really specify the version I want, so we will just end up using the latest version, if it breaks, it breaks, but I still enjoy having everything organized into different files. Finally, we will create the resources we want under <code>main.tf</code> which, in this case, is a Kubernetes namespace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-tf data-lang=tf><span class=line><span class=cl><span class=kr>resource</span> <span class=s2>&#34;kubernetes_namespace&#34;</span> <span class=s2>&#34;askeladden-staging&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>metadata</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=na>name</span> = <span class=s2>&#34;askeladden-staging&#34;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Note that we are using the Kubernetes backend, which will create a Kubernetes secret storing the Terraform state files. The secret has to go somewhere and, in <code>backend.tf</code>, I specified that it is goes into the <code>terraform</code> namespace, because I do not want things going into the default namespace. The namespace needs to exist prior to applying the Terraform changes so I&rsquo;m also going to add <code>infrastructure/k8s/tf-namespace.yaml</code> file with the following contents:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>terraform</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>Yes, I know, this kind of defeats the purpose of having terraform generate the namespaces for me, but I do not want to use the default Kubernetes namespace and I cannot use a Kubernetes Terraform backend in a namespace that does not exist.</p><h2 id=using-terraform>Using Terraform</h2><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fw" aria-hidden=true></i>mk<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>If you haven&rsquo;t read my previous posts, you will probably wonder what the <code>mk</code> command is. It is simply an alias for <code>microk8s kubectl</code>. Go read my previous posts, this is an adventure, you cannot start halfway.</div></div></div><p>We are ready to begin! Let&rsquo;s first have a look at what namespaces we have configured in our cluster using <code>mk get namespaces</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME                 STATUS   AGE
</span></span><span class=line><span class=cl>kube-system          Active   15d
</span></span><span class=line><span class=cl>kube-public          Active   15d
</span></span><span class=line><span class=cl>kube-node-lease      Active   15d
</span></span><span class=line><span class=cl>default              Active   15d
</span></span><span class=line><span class=cl>askeladden-dev       Active   14d
</span></span><span class=line><span class=cl>container-registry   Active   14d
</span></span></code></pre></td></tr></table></div></div><p>The <code>askeladden-dev</code> namespace is where our web server is deployed. Unfortunately for this namespace, it will not live for much longer. First, let&rsquo;s create the new <code>terraform</code> namespace, which will host the Terraform state files, using:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk apply -f infrastructure/k8s/tf-namespace.yaml
</span></span></code></pre></td></tr></table></div></div><p>Running <code>mk get namespaces</code> once again now shows our newly born namespace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>NAME                 STATUS   AGE
</span></span><span class=line><span class=cl>kube-system          Active   15d
</span></span><span class=line><span class=cl>kube-public          Active   15d
</span></span><span class=line><span class=cl>kube-node-lease      Active   15d
</span></span><span class=line><span class=cl>default              Active   15d
</span></span><span class=line><span class=cl>askeladden-dev       Active   14d
</span></span><span class=line><span class=cl>container-registry   Active   14d
</span></span><span class=line><span class=cl>terraform            Active   9s
</span></span></code></pre></td></tr></table></div></div><p>With the <code>terraform</code> namespace created, we can now navigate to <code>/infrastructure/terraform/</code> running:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>terraform init
</span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>terraform init<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content><code>terraform init</code> initializes a working directory containing Terraform configuration files and should always be ran prior to writing a new Terraform configuration. This will create a <code>.terraform/</code> directory, and a <code>.terraform.lock.hcl</code> file, along with <code>.tfstate</code> files in case the specified backend is local (in our case, we are using the Kubernetes backend, so the state files are kept in the Kubernetes cluster). The <code>.terraform.lock.hcl</code> file should be included in the version control repository, to be used as a discussion medium abour potential changes to external dependencies via code review. On the other hand, the <code>.terraform/</code> directory is basically a local cache, and should not be commited.</div></div></div><p>This will output the following:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Initializing the backend...
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Successfully configured the backend &#34;kubernetes&#34;! Terraform will automatically
</span></span><span class=line><span class=cl>use this backend unless the backend configuration changes.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Initializing provider plugins...
</span></span><span class=line><span class=cl>- Finding latest version of hashicorp/kubernetes...
</span></span><span class=line><span class=cl>- Installing hashicorp/kubernetes v2.19.0...
</span></span><span class=line><span class=cl>- Installed hashicorp/kubernetes v2.19.0 (signed by HashiCorp)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terraform has created a lock file .terraform.lock.hcl to record the provider
</span></span><span class=line><span class=cl>selections it made above. Include this file in your version control repository
</span></span><span class=line><span class=cl>so that Terraform can guarantee to make the same selections by default when
</span></span><span class=line><span class=cl>you run &#34;terraform init&#34; in the future.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terraform has been successfully initialized!
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>You may now begin working with Terraform. Try running &#34;terraform plan&#34; to see
</span></span><span class=line><span class=cl>any changes that are required for your infrastructure. All Terraform commands
</span></span><span class=line><span class=cl>should now work.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>If you ever set or change modules or backend configuration for Terraform,
</span></span><span class=line><span class=cl>rerun this command to reinitialize your working directory. If you forget, other
</span></span><span class=line><span class=cl>commands will detect it and remind you to do so if necessary.
</span></span></code></pre></td></tr></table></div></div><p>The aforementioned command also created a directory <code>.terraform</code> and a <code>.terraform.lock.hcl</code> file. To avoid forgetting about the existence of the <code>.terraform</code> and accidentally commiting this to my repository, I&rsquo;ll create a <code>.gitignore</code> file with the contents presented below:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>**/.terraform/
</span></span></code></pre></td></tr></table></div></div><div class="details admonition note open"><div class="details-summary admonition-title"><i class="icon fas fa-pencil-alt fa-fw" aria-hidden=true></i>.gitignore init<i class="details-icon fas fa-angle-right fa-fw" aria-hidden=true></i></div><div class=details-content><div class=admonition-content>If you have any intentionally untracked files and you want <code>git</code> to ignore them, you can create a <code>.gitignore</code> file at the root of the project&rsquo;s repository. You can then specify patterns inside this file, one patter per line, which <code>git</code> will use to match files the in project and ignore these matched files. This effectively means that these files will not exist in the remote repository.</div></div></div><p>If we want to see what resources Terraform will create/modify/destroy, we can use the <code>terraform</code> plan, which provides a pretty output of stating what will happen if the Terraform changes are applied:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Terraform used the selected providers to generate the following execution plan. Resource actions are
</span></span><span class=line><span class=cl>indicated with the following symbols:
</span></span><span class=line><span class=cl>  + create
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terraform will perform the following actions:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  # kubernetes_namespace.askeladden-staging will be created
</span></span><span class=line><span class=cl>  + resource &#34;kubernetes_namespace&#34; &#34;askeladden-staging&#34; {
</span></span><span class=line><span class=cl>      + id = (known after apply)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      + metadata {
</span></span><span class=line><span class=cl>          + generation       = (known after apply)
</span></span><span class=line><span class=cl>          + name             = &#34;askeladden-staging&#34;
</span></span><span class=line><span class=cl>          + resource_version = (known after apply)
</span></span><span class=line><span class=cl>          + uid              = (known after apply)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Plan: 1 to add, 0 to change, 0 to destroy.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>───────────────────────────────────────────────────────────────────────────────────────────────────────
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Note: You didn&#39;t use the -out option to save this plan, so Terraform can&#39;t guarantee to take exactly
</span></span><span class=line><span class=cl>these actions if you run &#34;terraform apply&#34; now.
</span></span></code></pre></td></tr></table></div></div><p>We can see that Terraform is going to create a Kubernetes namespace with the given parameters since it is marked with a <code>+</code> sign, neat! There&rsquo;s also a note at the end stating that Terraform cannot guarantee that these actions are the ones that will be performed when I run <code>terraform apply</code>, and that is completely true. In the time between me running <code>terraform plan</code> and <code>terraform apply</code>, some other developer in my imaginary team might have applied other Terraform changes that clash with mine. It is a risk I am willing to take. Funnily enough, running <code>terraform apply</code> produces the output of <code>terraform plan</code>:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Terraform used the selected providers to generate the following execution plan. Resource actions are
</span></span><span class=line><span class=cl>indicated with the following symbols:
</span></span><span class=line><span class=cl>  + create
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Terraform will perform the following actions:
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  # kubernetes_namespace.askeladden-staging will be created
</span></span><span class=line><span class=cl>  + resource &#34;kubernetes_namespace&#34; &#34;askeladden-staging&#34; {
</span></span><span class=line><span class=cl>      + id = (known after apply)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>      + metadata {
</span></span><span class=line><span class=cl>          + generation       = (known after apply)
</span></span><span class=line><span class=cl>          + name             = &#34;askeladden-staging&#34;
</span></span><span class=line><span class=cl>          + resource_version = (known after apply)
</span></span><span class=line><span class=cl>          + uid              = (known after apply)
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Plan: 1 to add, 0 to change, 0 to destroy.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Do you want to perform these actions?
</span></span><span class=line><span class=cl>  Terraform will perform the actions described above.
</span></span><span class=line><span class=cl>  Only &#39;yes&#39; will be accepted to approve.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  Enter a value:
</span></span></code></pre></td></tr></table></div></div><p>And prompts me to write <code>yes</code>, which is precisely what I&rsquo;ll do, after thoroughly verifying that the Terraform output matches what i want to create.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>kubernetes_namespace.askeladden-staging: Creating...
</span></span><span class=line><span class=cl>kubernetes_namespace.askeladden-staging: Creation complete after 0s [id=askeladden-staging]
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Apply complete! Resources: 1 added, 0 changed, 0 destroyed.
</span></span></code></pre></td></tr></table></div></div><p>Great, it seems Terraform performed exactly what we expected it to. Just to be completely sure that the namespace was created, let&rsquo;s run <code>mk get namespaces</code> once again:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME                 STATUS   AGE
</span></span><span class=line><span class=cl>kube-system          Active   15d
</span></span><span class=line><span class=cl>kube-public          Active   15d
</span></span><span class=line><span class=cl>kube-node-lease      Active   15d
</span></span><span class=line><span class=cl>default              Active   15d
</span></span><span class=line><span class=cl>askeladden-dev       Active   14d
</span></span><span class=line><span class=cl>container-registry   Active   14d
</span></span><span class=line><span class=cl>terraform            Active   14m
</span></span><span class=line><span class=cl>askeladden-staging   Active   60s
</span></span></code></pre></td></tr></table></div></div><p>And the future home for our web server is created!</p><h2 id=re-deploying-the-web-server-in-the-newly-created-namespace>Re-deploying the web server in the newly created namespace</h2><p>Note that I&rsquo;ve created a namespace called <code>askeladden-staging</code> and we have a namespace called <code>askeladden-dev</code>. For reasons that will become clear in future posts, I am now deprecating the <code>askeladden-dev</code> namespace, meaning that I have to deploy the web server into <code>askeladden-staging</code>, check that it is working, and then delete the <code>askeladden-dev</code> namespace along with the Kubernetes resources in it.</p><p>For consistency, we need to change two things in our Helm chart. The first is the <code>deploymentLabels</code>, in <code>services/askeladden/chart/values.yaml</code>. We currently have them set as:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>deploymentLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>dev</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>And we want to change them to:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>deploymentLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>env</span><span class=p>:</span><span class=w> </span><span class=l>staging</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>So that it matches the suffix of our namespace. Secondly, we still have our app deployed and exposed on port <code>30008</code>, which means that, if we attempt to deploy our new app, we will get an error message stating that this port is already in use. As such, we have to change the <code>nodePort</code> field, under <code>service</code>, to be something else. In this case, we will change it to <code>30009</code>.</p><p>After these changes, we can deploy our app to the <code>askeladden-staging</code> namespace using:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s helm upgrade askeladden services/askeladden/chart/askeladden --namespace=&#34;askeladden-staging&#34;
</span></span></code></pre></td></tr></table></div></div><p>It&rsquo;s impressive how much easier this is to perform with Helm than with plain Kubernetes. Now, if we navigate to <code>http://localhost:30009</code>, we should the see the Monty Python quote we&rsquo;ve been using:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>Strange women lying in ponds distributing swords is no basis for a system of government.
</span></span></code></pre></td></tr></table></div></div><p>Indeed it is, Monty Python, indeed it is. We can list our Helm releases for the <code>askeladden-staging</code> namespace using:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s helm list --namespace=&#34;askeladden-staging&#34;
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME      	NAMESPACE         	REVISION	UPDATED                                 	STATUS  	CHART           	APP VERSION
</span></span><span class=line><span class=cl>askeladden	askeladden-staging	2       	2023-03-29 23:17:48.168348961 +0100 WEST	deployed	askeladden-0.0.1	0.0.3
</span></span></code></pre></td></tr></table></div></div><p>Which just confirms what we already knew: our web server has been deployed successfully. However, if we run the above command for the <code>askeladden-dev</code> namespace:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>NAME      	NAMESPACE     	REVISION	UPDATED                                 	STATUS    CHART           	APP VERSION
</span></span><span class=line><span class=cl>askeladden	askeladden-dev	1       	2023-03-27 11:03:41.930152552 +0100 WEST	deployed  askeladden-0.0.1	0.0.3 
</span></span></code></pre></td></tr></table></div></div><p>We see that our web server still exists in the other namespace. Helm is also useful in case we want to remove delete old deployments, we simply have to run:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>microk8s helm uninstall askeladden --namespace=&#34;askeladden-dev&#34;
</span></span></code></pre></td></tr></table></div></div><p>Which outputs the message: <code>release "askeladden" uninstalled</code>. We can verify this operation with the <code>mk get all</code> command, which tells us exactly what we wanted to hear:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>No resources found in askeladden-dev namespace.
</span></span></code></pre></td></tr></table></div></div><p>I almost forgot, we have our context pointing to the <code>askeladden-dev</code> namespace. Let us change that before we delete the namespace so that it points to <code>askeladden-staging</code>. First, we create a new context with</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk config set-context askeladden-staging --namespace=askeladden-staging --cluster=microk8s-cluster --user=admin
</span></span></code></pre></td></tr></table></div></div><p>Just like we have done in the first post of these adventures. We have created the new context, so now we have to use it, which is easily achieved with:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk config use-context askeladden-staging
</span></span></code></pre></td></tr></table></div></div><p>If we now type <code>mk config current-context</code>, we get <code>askeladden-staging</code> as our output. We are going to delete the <code>askeladden-dev</code> so there is no point in keeping the <code>askeladden-dev</code> context around. We delete it through:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk config delete-context askeladden-dev
</span></span></code></pre></td></tr></table></div></div><p>Finally, we will delete our namespace using:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-plaintext data-lang=plaintext><span class=line><span class=cl>mk delete namespace askeladden-dev
</span></span></code></pre></td></tr></table></div></div><p>We can delete the <code>infrastructure/k8s/namespace.yaml</code> file that we had since it is no longer required.</p><p>And we are done! We have successfully used Terraform to create a new Kubernetes namespace in our <code>microk8s</code> cluster and migrated our web server to it using Helm!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-03-30</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/overengineering_adventures_3/ class=prev rel=prev title="Adventures in Overengineering 3: manning the Helm"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Adventures in Overengineering 3: manning the Helm</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Luís Franco</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>