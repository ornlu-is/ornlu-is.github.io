<!doctype html><html lang=en><head><script async src="https://www.googletagmanager.com/gtag/js?id=G-G300HG9GRT"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G300HG9GRT")</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Study Notes 1: A bird's-eye view of a Kubernetes cluster - Luís Franco</title><meta name=Description content="A bird's-eye view of how a Kubernetes cluster works"><meta property="og:title" content="Study Notes 1: A bird's-eye view of a Kubernetes cluster">
<meta property="og:description" content="A bird's-eye view of how a Kubernetes cluster works"><meta property="og:type" content="article"><meta property="og:url" content="https://ornlu-is.github.io/kubernetes_architecture_overview/"><meta property="og:image" content="https://ornlu-is.github.io/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-12T20:46:31+00:00"><meta property="article:modified_time" content="2023-11-12T23:27:11+00:00"><meta property="og:site_name" content="Super website"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://ornlu-is.github.io/logo.png"><meta name=twitter:title content="Study Notes 1: A bird's-eye view of a Kubernetes cluster"><meta name=twitter:description content="A bird's-eye view of how a Kubernetes cluster works"><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://ornlu-is.github.io/kubernetes_architecture_overview/><link rel=prev href=https://ornlu-is.github.io/overengineering_5/><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Study Notes 1: A bird's-eye view of a Kubernetes cluster","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/ornlu-is.github.io\/kubernetes_architecture_overview\/"},"genre":"posts","wordcount":1483,"url":"https:\/\/ornlu-is.github.io\/kubernetes_architecture_overview\/","datePublished":"2023-11-12T20:46:31+00:00","dateModified":"2023-11-12T23:27:11+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Luís Franco"},"description":"A bird's-eye view of how a Kubernetes cluster works"}</script></head><body data-header-desktop=auto data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/about/>About </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></span></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Luís Franco">Luís Franco</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/about/ title>About</a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Study Notes 1: A bird's-eye view of a Kubernetes cluster</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Luís Franco</a>
</span>&nbsp;<span class=post-category>included in <a href=/categories/kubernetes/><i class="far fa-folder fa-fw" aria-hidden=true></i>Kubernetes</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2023-11-12>2023-11-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1483 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#overview>Overview</a></li><li><a href=#kube-apiserver><code>kube-apiserver</code></a></li><li><a href=#etcd-server><code>etcd</code> server</a></li><li><a href=#kube-scheduler><code>kube-scheduler</code></a></li><li><a href=#controller-manager>Controller manager</a></li><li><a href=#container-runtime-interface>Container runtime interface</a></li><li><a href=#kubelet><code>kubelet</code></a></li><li><a href=#kube-proxy><code>kube-proxy</code></a></li><li><a href=#workflow-for-creating-a-pod>Workflow for creating a pod</a></li></ul></nav></div></div><div class=content id=content><p>I&rsquo;ve been meaning to do this for a while now. I&rsquo;ve studied quite a Kubernetes in the past year and have a ton of handwritten notes that I want to throw away, so I&rsquo;m transfering all of those notes into my blog. This is also a great review opportunity (and also has the added advantage that I will stop needing to comb through endless sheets of paper when I want to remember something). This is the first of such posts and it covers some basics around the architecture of a Kubernetes cluster.</p><h2 id=overview>Overview</h2><p>Kubernetes is basically a system for automating deployment, management, and scaling of containerized applications. In other words, it essentially allows you to automate a lot of systems management tasks in a relatively pain free way. Usually, if you want to use Kubernetes for something, you need access to a Kubernetes clusters, which consists on a set of nodes, called worker nodes, which can be physical or virtual, that will host you applications as containers. To manage these worker nodes, we need a centralized entity, which is a separate node known as the master node. This node contains an ample set of components that together form what is known as the Kubernetes control plane.</p><figure><img src=/images/kubernetes_overview/master_and_worker_nodes.png><figcaption><h4>Overview of master and worker nodes in Kubernetes</h4></figcaption></figure><p>Let us cover some of the components that exist in the master node. Note that the purpose of this post is not to provide an extensive list of these components, but rather a good enough list to understand the inner workings of a Kubernetes cluster. With that in mind, we have the follow cogs in a master node:</p><ul><li><code>kube-apiserver</code></li><li><code>etcd</code> server</li><li><code>kube-scheduler</code></li><li>Controller manager</li></ul><p>Likewise, each worker node also has its own components that are require for its normal functioning:</p><ul><li><code>kubelet</code></li><li><code>kube-proxy</code></li><li>Container Runtime Interface (CRI)</li></ul><p>Let us go through these one by one and then well look at how the Kubernetes cluster handles the simple task of creating a pod.</p><h2 id=kube-apiserver><code>kube-apiserver</code></h2><p>The <code>kube-apiserver</code> is possibly the most important component of Kubernetes, since it is responsible for orchestrating all operations within the cluster. Additionally, as the name suggests, it also exposes the Kubernetes API, which is used by external users to perform operations on the clusters, as well as by the various controllers to monitor the state of the cluster and make necessary changes as required. It is also the primary way that worker nodes communicate with the master node. If you have ever used the <code>kubectl</code> command, congratulations, you have performed a request to the <code>kube-apiserver</code>.</p><h2 id=etcd-server><code>etcd</code> server</h2><p>Information about the nodes and the various Kubernetes objects must be stored somewhere, and that&rsquo;s where <code>etcd</code> comes in. <code>etcd</code> is a distributed reliable key-value store that is simple, secure and fast (all the good qualities we want from a piece of software). Any and all changes performed in a Kubernetes cluster are recorded in the <code>etcd</code> server and are only considered complete precisely when they are stored.</p><h2 id=kube-scheduler><code>kube-scheduler</code></h2><p>Fortunately, Kubernetes employs a lot of meaningful naming, so we can correctly infer that the <code>kube-scheduler</code> is the control plane component that is in charge of scheduling. More specifically, it is in charge of scheduling pods on the available nodes taking into account existing constraints, such as the pod resource requirements, worker nodes capacity, etc. One very important detail is that it <em>only</em> takes care of scheduling, it doesn&rsquo;t actually place any pod on any node. Since this component has to take into account several different constraints, it&rsquo;s process to place a pod on a node generally has two phases:</p><ul><li>Firstly, it filters out any nodes that can immediately be deemed unfit for the pod, such as nodes with insufficient resources;</li><li>Then, it ranks the remaining nodes via a scoring function. There are several scoring functions that we can pick from, and we can even make our own custom scoring method.</li></ul><h2 id=controller-manager>Controller manager</h2><p>The controller manager is the component that takes care of managing the different controllers on our Kubernetes cluster. A controller is simply a process that continuously monitors the state of various objects withing the system and ensures that these are in the desired functioning state. Generally speaking, there is a controller for each type of Kubernetes objects, but we&rsquo;ll look at two examples: the replication controller and the node controller.</p><p>There is a type of Kubernetes object called ReplicaSet, which essentially is just a way of telling Kubernetes that we want our pod to have a given number of replicas. What actually ensures that we have the desired number of replicas is, you&rsquo;ve guessed it, the replication controller. Super simple.</p><p>A perhaps more interesting example of a controller is the node controller. This is the controller that is responsible for onboarding new nodes to the cluster and handling situations where these nodes become unavailable or are completely destroyed. Of course, to achieve this, this controller has to constantly monitor the nodes. By default, it does so every 5 seconds, a period known as the <em>node monitor period</em>. In case the node controller stops receiving a given node&rsquo;s heartbeat, the node controller waits 40 seconds for another heartbeat, a period known as the node monitor grace perior, and, if it does not get a heartbeat in that period, the node is marked as unreachable. After a node is marked as unreachable, the node controller waits for 5 minutes for it to come back up (pod eviction timeout). if it doesn&rsquo;t, then the pods assigned to that node are removed and provisioned on healthy nodes.</p><h2 id=container-runtime-interface>Container runtime interface</h2><p>The whole point of Kubernetes is to run containerized applications so we need something to actually run the containers, which is where the container runtime comes in. This is basically a dedicated piece of software used to run the containers and, naturally, it must exists on every worker node. Additionally, we can also have it running on the master node if we wish to host the control plane components as containers.</p><p>The Container Runtime Interface (CRI) was introduced in Kubernetes to allow for supporting multiple container runtimes. Basically, for a container runtime to work with Kubernetes, it must satisfy the following criteria:</p><ul><li>CRI - it must adhere to the defined interface;</li><li><code>imagespec</code> - its container images must be built according to the Open Container Initiative (OCI) specifications;</li><li><code>runtimespec</code> - the container runtime development must also adhere to the OCI specifications.</li></ul><p>Some time ago, Kubernetes used mostly Docker for its container runtime. However, as things evolved, Kubernetes no longer supports Docker as a container runtime and most of its deployments employ <code>containerd</code> instead.</p><h2 id=kubelet><code>kubelet</code></h2><p>A <code>kubelet</code> is an agent running on each worker node in a Kubernetes cluster that actively listens for instructions from the <code>kube-apiserver</code> and deploys/destroys containers on the node as required. It also periodically publishes status reports that are fetched by the <code>kube-apiserver</code> that allow for monitoring the status of the nodes and of the containers on them. Note that the <code>kubelet</code> doesn&rsquo;t create/destroy the containers itself, but it does relay those orders to the container runtime.</p><h2 id=kube-proxy><code>kube-proxy</code></h2><p>Last but not least, we have the <code>kube-proxy</code>. This is another component that is running on every worker node and its main job is to ensure that the necessary rules are in place on the worker nodes to allow the containers on them to communicate with each other. It is essentially a pod networking solution, <em>i.e.</em>, an internal virtual network spanning all nodes in the cluster. I&rsquo;ll dive further into this topic in a future post, because there is a lot to unpack here.</p><h2 id=workflow-for-creating-a-pod>Workflow for creating a pod</h2><p>Now we are ready to look at what happens in a Kubernetes cluster when we perform a request to create a pod! So let&rsquo;s dive in. It begins, obviously, with a user performing a request to the <code>kube-apiserver</code> to create a pod. This component will first authenticate and then validate the request and will then create the pod without assigning it to any node. Naturally, the information on the <code>etcd</code> cluster is also updated. At this point, the user receives a message back from the cluster stating that the pod has been created. Afterwards, the <code>kube-scheduler</code> monitoring loop picks up the existence of an unassigned pod, identifies the right node to place it on, and relays this information back to the <code>kube-apiserver</code>, which promptly writes it to the <code>etcd</code> data store. Now, the <code>kube-apiserver</code> passes that information along to the <code>kubelet</code> that is on the appropriate worker node for it to create the pod on the node and instruct the container runtime engine to pull and deploy the application image. Finally, the <code>kubelet</code> updates the status back to the <code>kube-apiserver</code> which once again updates the data on the <code>etcd</code> server.</p><p>While this might seem like a complicated workflow, it actually becomes fairly intuitive when we realize that Kubernetes is very modular in its construction, <em>i.e.</em>, every component on has one clearly defined function.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-11-12</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/overengineering_5/ class=prev rel=prev title="Adventures in Overengineering 5: Monitoring Raspberry Pi Machines with Prometheus and Grafana"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>Adventures in Overengineering 5: Monitoring Raspberry Pi Machines with Prometheus and Grafana</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Luís Franco</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=/lib/katex/katex.min.css><link rel=stylesheet href=/lib/katex/copy-tex.min.css><script type=text/javascript src=/lib/autocomplete/autocomplete.min.js></script><script type=text/javascript src=/lib/lunr/lunr.min.js></script><script type=text/javascript src=/lib/lazysizes/lazysizes.min.js></script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/lib/katex/katex.min.js></script><script type=text/javascript src=/lib/katex/auto-render.min.js></script><script type=text/javascript src=/lib/katex/copy-tex.min.js></script><script type=text/javascript src=/lib/katex/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>